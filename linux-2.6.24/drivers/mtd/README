1、Flash的内存存储结构
flash按照内部存储结构不同，分为两种：NOR flash和NAND flash。

NOR Flash 对比 NAND Flash

操作方式：NOR Flash和NAND Flash都是非常规块设备类型，块设备不区分写入和擦除操作，而Flash只能对空块或擦除后的块进行写入；因NOR Flash的接口与RAM完全相同，可以随机访问任意地址的数据，所以NOR Flash支持芯片内执行（XIP，eXecute In Place），即代码可以直接在NOR Flash上执行，无需复制到内存中（采样内存映射的方式）；

性能比较：NOR Flash读取速度比NAND Flash快，但写入或擦除速度远比NAND Flash慢；

生命周期：NOR Flash宣称擦写寿命是十万次，而NAND Flash宣陈擦写寿命是百万次（实际擦写寿命远大于宣称数值）；Flash的每一个bit位的寿命是独立的，某个bit位失效，不影响同字节其他bit位的正常操作；Flash磨损后，表现为擦除不干净，或者多擦除几次才能擦除干净，并且随着磨损程度的加剧，越来越难擦除干净，只有块擦除干净的情况下，写入才能成功；

差错校验：针对个别比特的失效，一般通过冗余比特替换或者错误检查和纠正的方法来进行纠正；冗余比特替换，是指在芯片设计时，每组存储单元会有若干个冗余比特，当该组存储单元存在失效的比特时，就可以用冗余比特加以替换，**冗余比特替换的方法常用于NOR Flash中**；错误检查和纠正（ECC），是指芯片中每组存储单元会有若干个比特用作数据的校验，当该组存储单元存在失效的比特，则通过相应的数据校验算法，还原真实的数据，**错误检查和纠正的方法常用于NAND Flash中**；

坏块处理：当失效的比特很多且连续时，失效比特所在的区域会被认为是集体失效，**在NOR Flash中，失效的区域通常会被冗余的存储单元块替换掉**（对上层使用完全透明，无需对超过磨损极限的坏块做特殊处理），**而在NAND Flash中，失效的区域会被标记为不可用，即坏块**（存在两种类型的坏块，一是先天性坏块，生产过程中产生，二是后天性坏块，使用过程种产生）；NAND Flash在读写以及擦除操作时，应主动跳过坏块以保证数据的完整性；


Q1：SPI Flash和CFI Flash有什么差异？
在通信方式上Nor Flash 分为两种类型：CFI Flash和 SPI Flash。即采用的通信协议不同。
CFI Flash：common flash interface公共闪存接口，是由存储芯片工业界定义的一种获取闪存芯片物理参数和结构参数的操作规程和标准；
SPI Flash：serial peripheral interface串行外围设备接口，是一种常见的时钟同步串行通信接口；
CFI接口，相对于串口的SPI来说，也被称为parallel接口，即并行接口。
区别在于：
1、SPI NOR Flash每次传输一bit位的数据，Parallel NOR Flash每次传输多个bit位的数据（0x8和0x16等）；
2、SPI NOR Flash比Parallel接口简单且实现成本更低，但速度较慢；

早期NOR Flash的通信接口是parallel（并行接口）的形式，即把数据线和地址线并排与处理器的管脚连接，但是后来发现不同容量的NOR Flash不能硬件上兼容（数据线和地址线的数量不一样），并且封装比较大，占用了较大的PCB板位置，所以后来逐渐被SPI（串行接口）取代。

此版内核中，m25p80.c为SPI NOR Flash的通用驱动程序，新的SPI Flash添加时需要在该驱动的支持列表（m25p_data）中增加对应的chip信息（jedec id、sector size等数据），在SPI驱动匹配到Flash设备时会通过发送OPCODE_RDID命令读取芯片的标识ID，并与驱动的支持列表进行比较，只有处在支持列表中的NOR Flash能正常启动。

2、MTD 子系统

MTD主要是为NOR Flash和NAND Flash设计的、用于访问内存设备的linux子系统，其在硬件和上层之间提供一个抽象的接口层，隐藏底层硬件设备差异并为上层应用提供统一的调用接口。

闪存即不是块设备，也不是字符设备，它们表现的类似块设备，但又有所不同，比如块设备不区分写入和擦除操作。

MTD提供了对字符设备MTD_CHAR（设备节点名为/dev/mtd）和块设备MTD_BLOCK（设备节点名为/dev/mtdblock）的支持，每个MTD原始设备都存在一个与之对应的字符设备和块设备，前者模拟字符设备用于对闪存原始字符的按序读写，后者模拟块设备用于挂载ext2等磁盘文件系统（FTL，Flash Translation Layer 闪存转换层）。

MTD块设备是通过转换层实现的，块设备读写单位为512字节的扇区，而MTD原始设备读写不是以扇区为单位进行的，转换层需在尽可能保证性能的情况下将按扇区读写的磁盘操作转换成MTD原始设备支持的Flash操作。比如：擦除块都大于扇区，扇区写入时避免每次都需要对整个擦除块执行读取、更新、擦除再写入的一整套耗时流程，通常增加一层数据缓存机制（如mtdblock.c的do_cached_write）。

A：NOR Flash可以按字节读（OPCODE_READ 0x03），以page（通常256B）为单位进行写入（OPCODE_PP 0x02，写入时若传递小于256字节的数据，则按照偏移位置完整写入，page内其他字节不受影响；若传递大于256字节的数据，则丢弃前面的数据，以最后256字节的数据写入page），以擦除块（通常64KB）为单位进行擦除（OPCODE_SE 0xd8），除非Flash支持更小单位的擦除操作，比如：4K擦除块（OPCODE_BE_4K 0x20）；
B：NAND Flash；
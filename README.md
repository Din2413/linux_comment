linux code comment for 2.6.24

在对linux 2.6.24进行注释的同时，总结输出自己对于各个内核模块的理解。

持续不断更新......

# 内存管理

## 内核空间

### 内存划分

- 物理内存

  - 内存节点 node

    - UMA 一致性内存访问
    - NUMA 非一致性内存访问

  - 内存管理区 zone

    - 水位线

      用于权衡系统内存空闲程度

      - high watermark
      - low watermark
      - min watermark

    - 类别

      根据系统特性划分，不同区域存在不同用处

      - DMA zone

      - Normal zone

      - Highmem zone

        高端内存

  - 物理页帧 page

- 虚拟内存

  虚拟内存让进程误以为可以访问系统的所有物理内存，其通过页表转换成物理内存。页表的级数越高每次获取虚拟内存存储在真实物理内存中的数据所需要进行的访存操作也就越多，如三级页表获取指定虚拟地址存储的数据需要三次访存操作，因此为减少虚拟地址到物理地址转换过程中访存次数，引入TLB页表缓存机制。

  - 页表

    完成虚拟内存到物理内存的转换

  - TLB缓存

### 内存映射

- 低端内存映射

  dma、normal zone

  - 直接映射

- 高端内存映射

  highmem zone

  - 永久映射
  - 临时映射

### 内存分配

- 连续内存

  - 按页分配

    alloc_pages

    - 伙伴系统

      按页管理物理内存，系统内存分配基础，所有可用内存均需通过伙伴系统管理后提供上层使。

  - 对象缓存

    通用对象缓存:kmalloc/kfree
    特殊对象缓存:kmem_cache_alloc/kmem_cache_free

    - slab分配器
    - slob分配器
    - slub分配器

- 非连续内存

  vmalloc/vfree

### 内存回收

- lru最近最少使用算法

  - active 活动链表

    从活动链表中筛选最近最少使用的页迁移至非活动链表

  - inactive 非活动链表

    从非活动链表中筛选内存页进行回收

    - 脏页写回

- 回收时机

  - 同步回收

    - MIN水位线不满足内存分配请求

  - 异步回收

    - LOW水位线唤醒kswap内核线程

## 进程空间

### 虚拟内存区

- 栈区

  自上而下增长

- mmap映射区

  mmap映射区位于栈区和堆区之间，且栈区自上而下增长，堆区自下而上增长。默认情况下，mmap区与堆一样，从堆区顶部开始自下而上增长（down_top），但这种进程空间分布会限制堆的可增长空闲必须位于mmap区之下，因此为放宽堆区的限制，引入另一个地址空间分布，即mmap区与栈一样，从栈区顶部开始自上而下增长（top_down）。

  如上，down_top会限制堆区扩展，而top_down则会限制栈区扩展，因此具体选择哪种空间分布因根据实际场景权衡选择

  - 文件映射

    虚拟内存区与某一文件映射，可通过内存方式直接读写文件。

  - 匿名映射

    虚拟内存区不与任一文件映射

- 堆区

  自上而下增长

- 数据区

- 代码区

### 内存分配

- malloc/free

- 延时分配

  初始只分配虚拟内存，将实际的物理内存分配推迟到真正需要访问时。

  虚拟内存状态:
  1.未分配；
  2.已分配、未映射；
  3.已映射、被换出不在内存中；
  4.已映射、在内存中；

- 写时复制

  最初创建子进程时，会对父进程做一次完全拷贝，这会增加不必要的内存拷贝工作，为解决该问题，引入写时复制机制。子进程只复制父进程的地址空间，而不拷贝实际的物理内存，且将共享内存写禁止，后续写时再通过缺页异常处理程序进行分配拷贝。

- 缺页异常

  因延迟分配、写时复制机制使得进程的虚拟内存可能并未与任何物理内存映射、或页权限与预期不匹配，当进程访问未映射的虚拟内存、或访问权限不匹配时，处理器会触发缺页异常，随后由缺页异常处理程序进行按需分页。

## 后续课题
1.内存水位线:high、low、min；</br>
2.内存映射:直接映射、永久映射、临时映射；</br>
3.内核空间内存分配:连续内存分配(伙伴系统、slab/slob/slub分配器)、非连续内存分配(vmalloc)；</br>
4.内存回收:回收时机、回收算法(扩展课题:磁盘页缓存、脏页回写)；</br>
5.进程地址空间:延时分配、mmap映射(匿名映射、文件映射)、elf目标文件(格式分析)；</br>
6:写时复制、缺页异常；
